jobs:
- job: DeployJob
  displayName: "Deploy App"
  pool:
    vmImage: ubuntu-latest

  workspace:
    clean: all

  #############################################################################
  # Steps
  #############################################################################
  steps:

    ###########################################################################
    # Download App Artifact
    ###########################################################################
    - task: DownloadPipelineArtifact@2
      displayName: "Download app artifact"
      inputs:
        artifactName: epic-build
        targetPath: "$(System.DefaultWorkingDirectory)/${{ parameters.appName }}/${{ parameters.codePath }}/.build"


    ###########################################################################
    # Deploy - HTML (static) and Angular (node)
    ###########################################################################
    - ${{ if or(eq(parameters.appType, 'html'), eq(parameters.appType, 'angular')) }}:
      - bash: |
          set -euo pipefail

          echo "Deploying ${{ parameters.appType }}..."

          BUILD_PATH="$(System.DefaultWorkingDirectory)/${{ parameters.appName }}/${{ parameters.codePath }}/.build"
          BUCKET_NAME="${{ parameters.s3 }}"
          DISTRIBUTION_ID="${{ parameters.cloudfront }}"

          echo "Syncing to S3..."
          aws s3 sync "$BUILD_PATH" "s3://$BUCKET_NAME" --delete

          echo "Invalidating CloudFront..."
          aws cloudfront create-invalidation \
            --distribution-id "$DISTRIBUTION_ID" \
            --paths "/*"

          echo "Deployment complete."
        displayName: "Deploy ${{ parameters.appType }}"
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)


    ###########################################################################
    # Deploy - .NET (core/framework)
    ###########################################################################
    - ${{ if or(eq(parameters.appType, 'dotnet_core'), eq(parameters.appType, 'dotnet_framework')) }}:
      ###########################################################################
      # Zip Published Output
      ###########################################################################
      - bash: |
          set -euo pipefail

          BUILD_PATH="$(System.DefaultWorkingDirectory)/${{ parameters.appName }}/${{ parameters.codePath }}/.build"

          cd "$BUILD_PATH"

          zip -r ../deploy.zip .

        displayName: "Create Deployment ZIP"


      ###########################################################################
      # Upload to S3
      ###########################################################################
      - bash: |
          set -euo pipefail

          ZIP_PATH="$(System.DefaultWorkingDirectory)/${{ parameters.appName }}/${{ parameters.codePath }}/deploy.zip"
          S3_BUCKET="${{ parameters.s3 }}"

          aws s3 cp "$ZIP_PATH" "s3://$S3_BUCKET/${{ parameters.appName }}.zip"

        displayName: "Upload ZIP to S3"
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)


      ###########################################################################
      # Deploy to EC2 via SSM (.NET)
      ###########################################################################
      - ${{ if or(eq(parameters.appType, 'dotnet_core'), eq(parameters.appType, 'dotnet_framework')) }}:
        - bash: |
            set -euo pipefail

            INSTANCE_ID="${{ parameters.ec2InstanceId }}"
            S3_BUCKET="${{ parameters.s3 }}"
            APP_NAME="${{ parameters.appName }}"

            echo "Deploying to EC2: $INSTANCE_ID"

            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy $APP_NAME" \
              --parameters commands="[
                \"set -e\",
                \"cd /opt/${{ parameters.appName }}\",
                \"sudo rm -rf api\",
                \"sudo mkdir -p api\",
                \"sudo aws s3 cp s3://$S3_BUCKET/$APP_NAME.zip .\",
                \"sudo unzip -o $APP_NAME.zip -d api\",
                \"sudo chmod +x /opt/${{ parameters.appName }}/api/${{ parameters.ec2Command }}\",
                \"sudo systemctl daemon-reload\",
                \"sudo systemctl stop ${{ parameters.appName }}-api || true\",
                \"sudo systemctl start ${{ parameters.appName }}-api\"
              ]"

          displayName: "Deploy to EC2 via SSM"
          env:
            AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
            AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
            AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)


      ###########################################################################
      # Deploy to EC2 via SSM (Python)
      ###########################################################################
      - ${{ if eq(parameters.appType, 'python') }}:
        - bash: |
            set -euo pipefail

            INSTANCE_ID="${{ parameters.ec2InstanceId }}"
            S3_BUCKET="${{ parameters.s3 }}"
            APP_NAME="${{ parameters.appName }}"

            echo "Deploying to EC2: $INSTANCE_ID"

            aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy $APP_NAME" \
              --parameters commands="[
                \"set -e\",
                \"sudo mkdir -p /opt/${{ parameters.appName }}\",
                \"cd /opt/${{ parameters.appName }}\",
                \"sudo rm -rf app\",
                \"sudo mkdir -p app\",
                \"sudo aws s3 cp s3://$S3_BUCKET/$APP_NAME.zip .\",
                \"sudo unzip -o $APP_NAME.zip -d app\",
                \"cd app\",
                \"sudo python3 -m venv venv\",
                \"sudo venv/bin/pip install -r requirements.txt\",
                \"sudo systemctl daemon-reload\",
                \"sudo systemctl stop ${{ parameters.appName }} || true\",
                \"sudo systemctl start ${{ parameters.appName }}\"
              ]"

          displayName: "Deploy to EC2 via SSM"
          env:
            AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
            AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
            AWS_SESSION_TOKEN: $(AWS_SESSION_TOKEN)
